name: Build Android AAB (Bubblewrap)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Bubblewrap CLI
        run: npm i -g @bubblewrap/cli

      - name: Restore keystore from secret
        shell: bash
        env:
          KEYSTORE_B64: ${{ secrets.KEYSTORE_B64 }}
        run: |
          echo "$KEYSTORE_B64" | base64 -d > signing.keystore
          ls -la

      - name: Create twa-manifest.json
        shell: bash
        env:
          WEB_MANIFEST_URL: ${{ secrets.WEB_MANIFEST_URL }}
        run: |
          cat > twa-manifest.json << 'JSON'
          {
            "packageId": "com.onrender.picnic_3.twa",
            "host": "picnic-3.onrender.com",
            "name": "Picnic Vakti",
            "launcherName": "Picnic",
            "display": "standalone",
            "themeColor": "#FF6600",
            "navigationColor": "#FF6600",
            "navigationColorDark": "#FF6600",
            "navigationDividerColor": "#FF6600",
            "navigationDividerColorDark": "#FF6600",
            "backgroundColor": "#FFFFFF",
            "startUrl": "/",
            "enableNotifications": false,
            "webManifestUrl": "WEB_MANIFEST_URL_REPLACE",
            "iconUrl": "https://picnic-3.onrender.com/static/icons/icon-512.png",
            "maskableIconUrl": "https://picnic-3.onrender.com/static/icons/icon-512.png",
            "appVersionName": "1.0.${{ github.run_number }}",
            "appVersionCode": ${{ github.run_number }},
            "fallbackType": "customtabs",
            "minSdkVersion": 19
          }
          JSON
          sed -i "s|WEB_MANIFEST_URL_REPLACE|$WEB_MANIFEST_URL|g" twa-manifest.json
          cat twa-manifest.json

      - name: Init TWA project
        run: npx bubblewrap init --manifest=twa-manifest.json --directory .

      - name: Build AAB
        env:
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASS: ${{ secrets.KEY_PASS }}
          STORE_PASS: ${{ secrets.STORE_PASS }}
        run: |
          npx bubblewrap build \
            --signingKey=signing.keystore \
            --signingKeyAlias="$KEY_ALIAS" \
            --signingKeyPassword="$KEY_PASS" \
            --keyStorePassword="$STORE_PASS"

      - name: Locate bundle
        id: findbundle
        run: |
          BUNDLE=$(find . -type f -name "*.aab" | head -n1)
          echo "bundle=$BUNDLE" >> $GITHUB_OUTPUT
          echo "Found: $BUNDLE"

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: picnic-aab
          path: ${{ steps.findbundle.outputs.bundle }}
